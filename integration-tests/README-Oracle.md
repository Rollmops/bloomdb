# Oracle Integration Tests

This directory contains Oracle integration tests for BloomDB.

## Prerequisites

1. **Docker** with at least 4GB RAM available
2. **Patience** - Oracle startup takes 5-10 minutes
3. **Oracle Database Free image access** - The official Oracle image requires accepting license terms

## Setup

### Option 1: Using Official Oracle Image (Recommended)

The official Oracle Database Free image is used by default:

```bash
# Run tests with default baseline version (0.5)
./run-oracle-tests.sh

# Run tests with custom baseline version
./run-oracle-tests.sh 1.2
```

### Option 2: Manual Oracle Setup

If you have an existing Oracle database, you can run the test script directly:

```bash
# Set environment variables for your Oracle instance
export DB_HOST="localhost"
export DB_PORT="1521" 
export DB_SERVICE="XEPDB1"
export DB_USER="bloomdb"
export DB_PASSWORD="bloomdb"

# Run the test
./integration-test-oracle.sh 0.5
```

## Oracle User Requirements

The bloomdb user requires the following permissions:
- CONNECT
- RESOURCE  
- CREATE VIEW
- CREATE SEQUENCE
- UNLIMITED TABLESPACE

The setup script automatically creates this user when using Docker.

## Expected Startup Time

- **First time**: 5-10 minutes (Oracle needs to create database files)
- **Subsequent runs**: 2-3 minutes

## Troubleshooting

### Container fails to start
```bash
# Check Docker logs
docker-compose -f docker-compose.oracle.yml logs

# Ensure enough RAM is available to Docker (minimum 4GB)
```

### Connection issues
```bash
# Test connection manually
docker exec bloomdb-oracle-test bash -c "echo 'SELECT 1 FROM DUAL;' | sqlplus -s bloomdb/bloomdb@XEPDB1"
```

### User creation issues
```bash
# Check if user was created
docker exec bloomdb-oracle-test bash -c "echo 'SELECT username FROM all_users WHERE username = '\''BLOOMDB'\'';' | sqlplus -s sys/Oracle123456@XEPDB1 as sysdba"
```

## Test Coverage

The Oracle integration tests cover:
- ✅ Baseline functionality with below-baseline detection
- ✅ Migration execution and rollback
- ✅ Failed migration handling and repair
- ✅ Checksum validation
- ✅ Missing file detection
- ✅ Repeatable migration updates
- ✅ Database cleanup (destroy)

## Oracle-Specific Considerations

1. **SQL Syntax**: Uses Oracle-specific syntax (NUMBER, VARCHAR2, CLOB, etc.)
2. **Identity Columns**: Uses `GENERATED BY DEFAULT AS IDENTITY`
3. **Foreign Keys**: Requires explicit constraint naming
4. **Case Sensitivity**: Oracle table names are uppercase by default
5. **Connection Format**: Uses `oracle://user:pass@host:port/service` format

## Cleanup

To stop and remove Oracle container:

```bash
docker-compose -f docker-compose.oracle.yml down -v
```

This removes the container and all data volumes.